version: 0.2

cache:
  paths:
    - node_modules/**/*
    - apps/backend/node_modules/**/*
    - packages/shared/node_modules/**/*

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "ðŸ“¦ Installing all workspace deps"
      - yarn install --frozen-lockfile

  build:
    commands:
      - echo "ðŸš€ Building backend + shared"
      - yarn build:be

  post_build:
    commands:
      - echo "ðŸ”§ Installing production deps into apps/backend/node_modules"
      # from repo root, install only prod deps of backend into its node_modules
      - yarn install \
        --production \
        --frozen-lockfile \
        --modules-folder apps/backend/node_modules \
        --ignore-workspace-root-check

      - echo "ðŸ“¦ Zipping deployable artifact"
      # now package dist + that node_modules + manifest files
      - cd apps/backend
      - zip -r ../../backend-deploy.zip dist node_modules package.json yarn.lock
      - echo "âœ… backend-deploy.zip ready"

artifacts:
  files:
    - backend-deploy.zip
