packages:
  yum:
    wget: []
    tar: []
    curl: []

commands:
  01_download_ollama:
    command: |
      mkdir -p /opt/ollama
      curl -fsSL -o /tmp/ollama.tar.gz https://ollama.com/download/ollama-linux-amd64.tar.gz
      if [ ! -s /tmp/ollama.tar.gz ]; then
        echo "Download failed or empty file." >&2
        exit 1
      fi
      tar -xzf /tmp/ollama.tar.gz -C /opt/ollama
      chmod +x /opt/ollama/ollama

  02_pull_models:
    command: |
      /opt/ollama/ollama serve &
      sleep 10
      /opt/ollama/ollama pull mistral
      /opt/ollama/ollama pull nomic-embed-text
    ignoreErrors: false

  03_setup_systemd_service:
    command: |
      cat <<EOF > /etc/systemd/system/ollama.service
      [Unit]
      Description=Ollama Server
      After=network.target

      [Service]
      ExecStart=/opt/ollama/ollama serve
      Restart=always
      User=root

      [Install]
      WantedBy=multi-user.target
      EOF

      systemctl daemon-reload
      systemctl enable ollama
      systemctl start ollama

  04_configure_nginx_proxy:
    command: |
      cat <<EOF > /etc/nginx/conf.d/ollama-proxy.conf
      server {
          listen 80;
          location /ollama/ {
              proxy_pass http://localhost:11434/;
              proxy_http_version 1.1;
              proxy_set_header Upgrade \$http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host \$host;
              proxy_cache_bypass \$http_upgrade;
          }
      }
      EOF
      nginx -s reload

container_commands:
  01_restart_nginx:
    command: service nginx restart
